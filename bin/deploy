#!/bin/bash
set -e
set -u
set -o pipefail

# TODO: add CloudFront provisioning per version
# TODO: add Route53 provisioning per version
# TODO: add CloudFront invalidation per version

pushd "$(dirname $0)" > /dev/null
SCRIPTPATH="$(pwd)"
popd > /dev/null

PROJECTPATH="${SCRIPTPATH}/../"

VERSION=$(cat "${PROJECTPATH}/VERSION")
SRC="${PROJECTPATH}/dist"

BUCKET="${VERSION}.python-editor.microbit.org"

if ! aws s3api head-bucket --bucket "${BUCKET}" > /dev/null 2>&1; then
  POLICY=$(mktemp)
  sed -e "s/{{BUCKET_NAME}}/${BUCKET}/g" policy.tmpl.json > "$POLICY"

  aws s3api create-bucket --bucket "${BUCKET}" --region eu-west-1 --create-bucket-configuration LocationConstraint=eu-west-1
  aws s3 website "s3://${BUCKET}/" --index-document index.html --error-document error.html
  aws s3api put-bucket-policy --bucket "${BUCKET}" --policy "file://${POLICY}"
fi

aws s3 sync "${SRC}" "s3://${BUCKET}" --delete
